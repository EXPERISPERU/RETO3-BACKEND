using backend.services.Utils;
using iText.Html2pdf.Resolver.Font;
using iText.Html2pdf;
using iText.Kernel.Geom;
using iText.Kernel.Pdf;
using Microsoft.AspNetCore.Mvc;
using iText.Layout.Element;
using iText.Layout.Properties;
using iText.Layout;
using backend.domain;
using iText.Kernel.Events;
using iText.Kernel.Pdf.Canvas;
using iText.IO.Image;

namespace backend.services.Controllers.Maestros
{
    [Route("api/[controller]")]
    [ApiController]
    public class AdjuntoController : ControllerBase
    {

        [HttpPost("[action]")]
        public async Task<ActionResult<ApiResponse<string>>> UploadFile([FromBody] imbFile file)
        {
            FtpClient ftpClient = new FtpClient();
            var rsp = ftpClient.UploadFile(file);

            return StatusCode(StatusCodes.Status200OK, rsp);
        }

        [HttpGet("[action]")]
        public async Task<ActionResult> DownloadFile(string sRutaFile)
        {
            try
            {
                FtpClient client = new FtpClient();
                byte[] file = client.DownloadFile(sRutaFile);
                var extension = sRutaFile.Split('/')
                                            .Last()
                                            .Split('.')
                                            .Last()
                                            .ToLower();
                return File(file, client.sContentType(extension), sRutaFile.Split('/').Last());
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Error interno del servidor: {ex.Message}");
            }
        }

        [HttpGet("[action]")]
        public async Task<ActionResult> GetFormato()
        {
            try
            {
                var sCuerpo = "<!DOCTYPE html>\r\n<html lang=\"es\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>PAGARE</title>\r\n    <style>\r\n        body {\r\n            font-size: 12px;\r\n            font-family: Arial, Helvetica, sans-serif;\r\n        }\r\n\r\n        .casilla {\r\n            border-style: solid;\r\n            border-width: 1px;\r\n            border-color: black;\r\n            padding: 5px;\r\n        }\r\n    </style>\r\n</head>\r\n<body>\r\n    <div>\r\n        <img style=\"width: 120px\" src=\"logo_inmobitec.png\" alt=\"Logo Inmobitec\">\r\n    </div>\r\n    <div>\r\n        <h1 style=\"text-align: center;\">PAGARÉ</h1>\r\n    </div>\r\n    <div>\r\n        <table style=\"width: 100%; border-collapse: collapse; font-weight: bold; text-align: center;\">\r\n            <tr class=\"casilla\">\r\n                <td class=\"casilla\" style=\"width: 20%;\">\r\n                    Código\r\n                    <br/>\r\n                    <br/>\r\n                    #sCodigoContrato#\r\n                </td>\r\n                <td class=\"casilla\" style=\"width: 20%;\">\r\n                    Lugar de Emisión\r\n                    <br/>\r\n                    <br/>\r\n                    LIMA\r\n                </td>\r\n                <td class=\"casilla\" style=\"width: 20%;\">\r\n                    Fecha de Emisión\r\n                    <br/>\r\n                    <br/>\r\n                    #sFechaEmision#\r\n                </td>\r\n                <td class=\"casilla\" style=\"width: 20%;\">\r\n                    Fecha de Vencimiento\r\n                    <br/>\r\n                    <br/>\r\n                    #FechaVencimiento#\r\n                </td>\r\n                <td class=\"casilla\" style=\"width: 20%;\">\r\n                    Importe\r\n                    <br/>\r\n                    <br/>\r\n                    #sImporte#\r\n                </td>\r\n            </tr>\r\n        </table>\r\n        <p style=\"margin-top: 10px; margin-bottom: 10px; text-align: justify;\">\r\n            Por este PAGARÉ prometo(emos) pagar incondicionalmente a la empresa <b>Multiservicios e Inversiones Inmobitec S.A.C.</b> con RUC. 20601682819, la cantidad de:\r\n        </p>\r\n        <p style=\"font-size: 20px; margin-top:10px; margin-bottom: 10px;\"><b>#nMontoFinanciado#</b></p>\r\n        <div style=\"font-size: 15px\">\r\n            <div style=\"margin-bottom: 10px; text-decoration: underline;\">\r\n                <strong class=\"underline\">Datos del Emitente</strong><br>\r\n            </div>\r\n            <div>\r\n                <strong>#sNombreCliente#</strong>\r\n            </div>\r\n            <div>\r\n                #sTipoDocumento#: <strong>#sDocumento#</strong>\r\n            </div>\r\n            <div>\r\n                Domicilio: <strong>#sDireccion#</strong>\r\n            </div>\r\n        </div>\r\n        <div style=\"font-size: 15px; margin-top: 20px\">\r\n            <div style=\"margin-bottom: 10px; text-decoration: underline;\"><strong class=\"underline\">Datos del Aval</strong><br> </div>\r\n            <div>\r\n                <div><b>Nombres y Apellidos:</b>\r\n                </div>\r\n                <div>DNI: <b></b></div>\r\n                <div>Domicilio: <b></b></div>\r\n                <div style=\"margin-top: 30px\">Firma del Aval</div>\r\n            </div>\r\n        </div>\r\n        <br>\r\n        <p style=\"font-size: 13px; text-align: justify;\">\r\n            Este pagaré se emite completo de conformidad a la cláusula décimo segunda del “Contrato de servicios de\r\n            obra”, que el suscriptor de este pagare celebro con Multiservicios e Inversiones Inmobitec S.A.C.\r\n            Clausulas especiales\r\n            <ol style=\"font-size: 13px; text-align: justify;\">\r\n                <li>Este pagaré solo debe ser pagado en la misma moneda que expresa este título valor.</li>\r\n                <li>A su vencimiento podrá ser pagado por su tenedor, por el plazo que este señale en este mismo documento,\r\n                    sin que sea necesario intervención alguna del obligado principal ni de sus solidarios.\r\n                </li>\r\n                <li>Desde su último vencimiento, su importe total y/o cuotas, generará intereses compensatorios más\r\n                    moratorios a las tasas máximas autorizadas o permitidas a su tenedor.</li>\r\n                <li>El presente pagaré no requiere ser protestado por falta de pago, procediendo su ejecución por el solo\r\n                    mérito de haber sido su plazo autorizadas o permitidas a su tenedor.</li>\r\n                <li>La empresa Multiservicios e Inversiones Inmobitec S.A.C. queda autorizada para prorrogar este pagaré\r\n                    cuando así lo estime conveniente, ya sean estas prorrogas por el importe total o por cantidad menor, sin\r\n                    requerir para dichos efectos la suscripción del otorgante.</li>\r\n                <li>El importe indicado en el presente título generará interés compensatorio a partir de su fecha de\r\n                    emisión, a partir de su vencimiento, la mora se producirá sin necesidad de requerimiento alguno y\r\n                    generara concepto de interés compensatorio y moratorio legal.</li>\r\n            </ol>\r\n        </p>\r\n        <div style=\"width: 100%; align-content: center; margin-top: 75px;\">\r\n            <div style=\"border-top: 1px solid black; width: 200px; margin: auto; text-align: center;\">\r\n                <strong>FIRMA DEL EMITENTE</strong>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</body>\r\n</html>";

                var html = "<style>.page-break { page-break-after: always; } </style>";

                html += "<div class=\"page-break\">";
                html += sCuerpo
                        .Replace("logo_inmobitec.png", dataImages.logoInmobitec2023);
                html += "</div>";

                string path = System.IO.Path.Combine(System.IO.Path.GetTempPath(), Guid.NewGuid() + ".pdf");
                ConverterProperties properties = new ConverterProperties();
                properties.SetFontProvider(new DefaultFontProvider(true, true, true));
                PdfDocument pdfDocument = new PdfDocument(new PdfWriter(path));
                pdfDocument.SetDefaultPageSize(new PageSize(PageSize.A4));

                HtmlConverter.ConvertToPdf(html, pdfDocument, properties);

                byte[] file = System.IO.File.ReadAllBytes(path);
                return File(file, "application/pdf");
            }
            catch (Exception)
            {

                throw;
            }
        }

        [HttpGet("[action]")]
        public async Task<ActionResult> GetFormatoPageNumber()
        {
            try
            {
                var sCuerpo = "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>CONTRATO DE OBRA</title>\r\n\r\n    <style>\r\n        @page {\r\n            margin: 0cm 0cm;\r\n            text-align: justify;\r\n        }\r\n\r\n        body {\r\n            margin-top: 2.5cm;\r\n            margin-bottom: 2.25cm;\r\n            margin-left: 2.25cm;\r\n            margin-right: 2.25cm;\r\n        }\r\n\r\n        h1 {\r\n            font-size: 18px;\r\n        }\r\n\r\n        * {\r\n            font-size: 14px;\r\n            font-family: 'century-gothic, sans-serif';\r\n        }\r\n\r\n        .text-center {\r\n            text-align: center;\r\n        }\r\n\r\n        .clause-content td:first-child {\r\n            vertical-align: top;\r\n            padding-right: 30px;\r\n        }\r\n\r\n        .clause-content td {\r\n            text-align: justify;\r\n        }\r\n\r\n        .clause-content tr:not(:first-child) {\r\n            margin-top: 10px;\r\n        }\r\n    </style>\r\n</head>\r\n<body>\r\n    <div style=\"padding: 40px 0px 0px 0px; text-align: justify\">\r\n        <div style=\"text-align: right\">#sCodigoContrato#</div>\r\n        <br>\r\n        <h2 style=\"text-align: center\">\r\n            CONTRATO DE OBRA PARA LA HABILITACIÓN FÍSICA Y LA CONSTRUCCIÓN DE ÁREAS COMUNES DENTRO DEL PROGRAMA SOCIAL DE VIVIENDA – #sProyecto# – VERSION 2024\r\n        </h2>\r\n    </div>\r\n    <div style=\"text-align: justify;\">\r\n        <p>\r\n            <strong>MULTISERVICIOS E INVERSIONES INMOBITEC SAC</strong> CONSTITUIDA BAJO LA LEY GENERAL DE SOCIEDADES, AQUIEN SE LE DENOMINARÁ <strong>INMOBITEC</strong> IDENTIFICADA CON REGISTRO ÚNICO DE CONTRIBUYENTE N.º 20601682819, CON DOMICILIO FISCAL EN CALLE CHINCHON N° 910 DISTRITO DE SAN ISIDRO, PROVINCIA Y DEPARTAMENTO DE LIMA. DEBIDAMENTE REPRESENTADA POR EL SEÑOR <strong>LUIS ENRIQUE GUTIERREZ PARDO</strong> DE NACIONALIDAD PERUANA, OCUPACIÓN ADMINISTRADOR, CON DOCUMENTO DE IDENTIDAD N°. 41006846, ESTADO CIVIL SOLTERO, CON DOMICILIO EN CALLE CHINCHON N° 910 DISTRITO DE SAN ISIDRO, PROVINCIA Y DEPARTAMENTO DE LIMA. SEGÚN PODERES INSCRITOS EN LA PARTIDA ELECTRÓNICA N°. 40626875 DEL REGISTRO DE PERSONAS JURÍDICAS DE LIMA Y;\r\n        </p>\r\n        <p>\r\n            Y DE LA OTRA PARTE, #sNombreCliente#, DE NACIONALIDAD PERUANA, IDENTIFICADA CON #sTipoDocumento# N°. #sDocumento#, DE ESTADO CIVIL #sEstadoCivil#, CON DOMICILIO EN #sDireccion#, CELULAR N°. #sCelular# Y CORREO ELECTRÓNICO #sCorreo# A QUIEN EN ADELANTE SE LE DENOMINARÁ EL <strong>BENEFICIARIO</strong>; EN LOS TÉRMINOS Y CONDICIONES CONTENIDAS EN LAS SIGUIENTES CLAUSULAS:\r\n        </p>\r\n        <hr>\r\n        <br>\r\n        <div class=\"first-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA PRIMERA: GLOSARIO DE TÉRMINOS</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>1.1</td>\r\n                    <td><strong>BENEFICIARIO:</strong> PERSONA NATURAL QUE DE ACUERDO CON EL PROGRAMA NO CUENTA CON UNA VIVIENDA INSCRITA EN REGISTROS PÚBLICOS Y ES MAYOR DE EDAD.</td>\r\n\r\n                </tr>\r\n                <tr>\r\n                    <td>1.2</td>\r\n                    <td><strong>ASOCIACIÓN DE VIVIENDA CENTRO URBANO “#sProyecto#”</strong>: ES LA ORGANIZACIÓN QUE TIENE POR FINALIDAD LA ORGANIZACIÓN INTERNA DE LOS BENEFICIARIOS PARA LA FORMALIZACIÓN DE LA POSESIÓN A PROPIEDAD.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>1.3</td>\r\n                    <td><strong>MEDIO DE PAGO</strong>: MECANISMO ELECTRÓNICO O DIGITAL QUE PERMITE REALIZAR TRANSACCIONES ECONÓMICAS.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>1.4</td>\r\n                    <td><strong>ÁREAS COMUNES</strong>: ESPACIOS DESTINADOS PARA LA IMPLEMENTACIÓN DE INFRAESTRUCTURA QUE GENERE BIENESTAR EN LOS BENEFICIARIOS.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>1.5</td>\r\n                    <td><strong>SERVICIOS BÁSICOS ALTERNATIVOS</strong>: SON SERVICIOS BÁSICOS NO TRADICIONALES Y AUTO SUSTENTADOS EN EL MARCO DE LOS PROGRAMAS SE CARACTERIZAN POR SU TEMPORALIDAD.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>1.6</td>\r\n                    <td><strong>HABILITACIÓN FÍSICA</strong>: ES LA GENERACIÓN DE CONDICIONES PARA PROVEER ESPACIOS PÚBLICOS Y DE INFRAESTRUCTURAS DE SERVICIOS ADECUADA A UNA DETERMINADA POBLACIÓN.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\" second-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA SEGUNDA: ANTECEDENTES</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>2.1</td>\r\n                    <td>EL <strong>“PROGRAMA SOCIAL DE VIVIENDA #sProyecto#”</strong> TIENE POR OBJETO OTORGAR ÁREAS EN POSESIÓN DEBIDAMENTE HABILITADAS PARA QUE SU PÚBLICO BENEFICIARIO PUEDA ADECUAR UNA VIVIENDA.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>2.2</td>\r\n                    <td>LA EMPRESA <strong>MULTISERVICIOS E INVERSIONES INMOBITEC SAC</strong> Y LA <strong>“ASOCIACIÓN PROGRAMAS SOCIALES DE VIVIENDA DEL SUR”</strong> HAN SUSCRITO UN CONVENIO CON LA FINALIDAD DE ESTABLECER LAS CONDICIONES DE COOPERACIÓN CON LA FINALIDAD DE A HACER POSIBLE EL PROYECTO PROGRAMA SOCIAL DE VIVIENDA <strong>“#sProyecto#”</strong> Y EN VIRTUD DE ELLO LA EJECUCIÓN DE OBRAS DE HABILITACIÓN FÍSICA DEL PREDIO, UBICADO EN EL SECTOR PAMPAS DEL CONCON, DISTRITO DE SAN VICENTE DE CAÑETE, PROVINCIA DE CAÑETE, DEPARTAMENTO DE LIMA.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>2.3</td>\r\n                    <td>EL <strong>BENEFICIARIO</strong>, HA CELEBRADO UN CONTRATO DE TRANSFERENCIA DE DERECHOS DE POSESIÓN A TÍTULO GRATUITO SOBRE UNA ÁREA DE TERRENO DE #nMetraje# M2 UBICADO EN EL <strong>LOTE</strong> #sLote#, <strong>MZ</strong> #sManzana# DEL PROGRAMA SOCIAL DE VIVIENDA #sProyecto# DEL SECTOR PAMPAS DE CONCÓN TOPARA - KM 156 PANAMERICANA SUR, DISTRITO DE SAN VICENTE, PROVINCIA DE CAÑETE, DEPARTAMENTO DE LIMA.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"third-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA TERCERA: OBJETO DEL CONTRATO</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>3.1</td>\r\n                    <td>POR EL PRESENTE CONTRATO <strong>INMOBITEC</strong> SE OBLIGA A EJECUTAR OBRAS DE HABILITACIÓN FÍSICA, INFRAESTRUCTURA DE ÁREAS COMUNES, Y ADECUACIÓN DE SERVICIOS BÁSICOS ALTERNATIVOS DEL CENTRO URBANO #sProyecto#, UBICADO EN EL SECTOR PAMPAS DE CONCÓN TOPARA - KM 156 PANAMERICANA SUR, DISTRITO DE SAN VICENTE, PROVINCIA DE CAÑETE, DEPARTAMENTO DE LIMA, CONFORME AL <strong>ANEXO I</strong> DEL PRESENTE CONTRATO.</td>\r\n\r\n                </tr>\r\n                <tr>\r\n                    <td>3.2</td>\r\n                    <td>AMBAS PARTES DEJAN ESTABLECIDO QUE LAS OBRAS DESCRITAS EN EL <strong>ANEXO I</strong> SON EXTERNAS AL ÁREA ASIGNADA AL <strong>BENEFICIARIO</strong> DENTRO DEL PROGRAMA SOCIAL DE VIVIENDA #sProyecto#. ASIMISMO, LAS OBRAS EN MENCIÓN SON INTEGRALES AL CENTRO URBANO #sProyecto#.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"fourth-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA CUARTA: CONTRAPRESTACIÓN ECONÓMICA, FORMA Y OPORTUNIDAD DE PAGO</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>4.1</td>\r\n                    <td>POR SU PARTE EL <strong>BENEFICIARIO</strong> SE OBLIGA A PAGAR A FAVOR DE <strong>INMOBITEC</strong> EL IMPORTE DE S/#nMontoFinal# (#nMontoFinalLetras#) COMO CONTRAPRESTACIÓN ECONÓMICA POR LOS SERVICIOS MATERIA DEL PRESENTE CONTRATO.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>4.2</td>\r\n                    <td>CUYA FORMA DE PAGO SE REALIZARÁ CON UNA CUOTA INICIAL ASCENDENTE A S/ #nMontoInicial# (#nMontoInicialLetras#) QUE SE ABONARÁ EN LA CUENTA RECAUDADORA DE <strong>INMOBITEC</strong> DEL BANCO BBVA CONTINENTAL EN MONEDA NACIONAL.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>4.3</td>\r\n                    <td>ASÍ COMO, EL PAGO DE LAS CUOTAS MENSUALES DEL IMPORTE FINANCIADO DESCRITAS EN EL <strong>ANEXO II</strong> DEL PRESENTE CONTRATO.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>4.4</td>\r\n                    <td>LAS PARTES DEJAN ESTABLECIDO LA POSIBILIDAD QUE <strong>INMOBITEC</strong> PUEDA MODIFICAR UNILATERALMENTE EL <strong>MEDIO DE PAGO</strong>, EN CONFORMIDAD AL TUO DE LA LEY NRO. 28194, PREVIA COMUNICACIÓN MEDIANTE CARTA A SU DOMICILIO Y/O CORREO ELECTRONICO Y/O NÚMERO TELÉFONO DE WHATSAPP.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"fifth-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA QUINTA: SERVICIO A SUMA ALZADA</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>5.1</td>\r\n                    <td>LAS PARTES ESTABLECEN QUE LA CONTRAPRESTACIÓN SE FIJA A SUMA ALZADA, ES DECIR, ESTA INCLUYE LOS MATERIALES DE LA OBRA, INSTRUMENTOS Y LOS SERVICIOS REQUERIDOS PARA SU CUMPLIMIENTO DEL CONTRATO, NO PUDIENDO <strong>INMOBITEC</strong> REQUERIR A EL <strong>BENEFICIARIO</strong> LA DOTACIÓN DE MATERIAL ALGUNO.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>5.2</td>\r\n                    <td>EN MÉRITO DE LO ESTABLECIDO EN LA CLÁUSULA ANTERIOR <strong>INMOBITEC</strong> SE DECLARA RESPONSABLE POR LA CALIDAD DE LOS MATERIALES A EMPLEARSE EN LA OBRA, LOS QUE CUMPLIRÁN CON LO ESTABLECIDO EN LOS DISPOSITIVOS DEL REGLAMENTO NACIONAL DE EDIFICACIONES VIGENTE.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"sixth-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA SEXTA: PLAZO DEL CONTRATO </strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>6.1</td>\r\n                    <td>SIENDO ESTE UN CONTRATO DE OBRA LAS PARTES CONVIENEN FIJAR UN PLAZO DE DURACIÓN DETERMINADA DENTRO DEL CUAL <strong>INMOBITEC</strong> SE OBLIGA A CUMPLIR INTEGRAMENTE CON LA PRESTACIÓN A SU CARGO, HASTA POR UN PLAZO DE 10 (DIEZ) AÑOS DESDE LA FECHA DE SUSCRIPCIÓN DEL PRESENTE CONTRATO.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>6.2</td>\r\n                    <td>SIN PERJUCIO DE LO ANTERIOR INMOBITEC HARÁ ENTREGA DEL AVANCE DE LAOBRA CONFORME EL SIGUIENTE DETALLE:\r\n                        <ol type=\"A\">\r\n                                <li>\r\n                                    ASIGNACIÓN DE LOTE CON ACTA DE ENTREGA Y PLANO DE UBICACIÓN.\r\n                                </li>\r\n                                <li>\r\n                                    MOVIMIENTO DE TIERRAS, AVANCE DE OBRAS Y LOTIZACIÓN DE ACUERDO CON EL CRONAGRAMA DE AVANCE DE OBRA.\r\n                                </li>\r\n                                <li>\r\n                                    ENTREGA DE LA OBRA FINAL DE ACUERDO CON EL CRONOGRAMA DE AVANCE DE OBRA.\r\n                                </li>\r\n                        </ol>\r\n                        INMOBITEC PODRÁ ADELANTAR LA EJECUIÓN DE LAS OBRAS Y COMUNICAR ANTICIPADAMENTE A LA ASOCIACIÓN PARA SU RECEPCIÓN Y ENTREGA AL BENEFICIARIO.\r\n                    </td>\r\n                </tr>\r\n                <tr>\r\n                    <td>6.3</td>\r\n                    <td>ASÍ MISMO, EL PLAZO DE LA OBRA ESTÁ SUJETA AL TIEMPO QUE DEMANDE LA CONSTRUCCIÓN DE LAS OBRAS DE HABILITACIÓN FÍSICA EN ÁREAS COMUNES, SIEMPRE Y CUANDO, NO SE PRESENTEN HECHOS FORTUITOS O DE FUERZA MAYOR QUE DIFIERAN EL PLAZO DE EJECUCIÓN.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"seventh-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA SÉPTIMA: OBLIGACIONES DE LAS PARTES</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>7.1</td>\r\n                    <td>EL <strong>BENEFICIARIO</strong> ESTÁ OBLIGADO A PAGAR LAS CUOTAS CORRESPONDIENTES AL <strong>ANEXO II</strong> EN LA CUENTA RECAUDADORA ASIGNADA POR <strong>INMOBITEC</strong> EN LA FORMA Y OPORTUNIDAD PACTADA EN LA CLÁUSULA CUARTA.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>7.2</td>\r\n                    <td><strong>INMOBITEC</strong>, SE OBLIGA A EJECUTAR LA PRESTACIÓN A SU CARGO DONDE <strong>LA ASOCIACIÓN</strong> ES LA ADMINISTRADORA DEL PROYECTO, EN LA FORMA MÁS DILIGENTE POSIBLE, PROCURANDO LA MAYOR EFICIENCIA DE SUS SERVICIOS Y CUMPLIENDO CON LOS PLAZOS ESTABLECIDOS EN LOS ANEXOS DEL CONTRATO.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"eighth-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA OCTAVA: GARANTÍA DE PAGO</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>8.1</td>\r\n                    <td>EL <strong>BENEFICIARIO</strong>, CON LA FINALIDAD DE GARANTIZAR EL PAGO TOTAL POR EL SERVICIO DE OBRA SUSCRIBIRÁ UN PAGARÉ POR EL IMPORTE A FINANCIAR (SEGÚN <strong>ANEXO II</strong>) A NOMBRE DE <strong>INMOBITEC</strong>. EL INDICADO DOCUMENTO LE SERÁ DEVUELTO A EL <strong>BENEFICIARIO</strong> CUANDO SE CULMINE EL PAGO DE LA CONTRAPRESTACIÓN QUE INDICA EL NUMERAL 4.2 DE LA CLÁUSULA CUARTA.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>8.2</td>\r\n                    <td>EN CASO DE INCUMPLIMIENTO DE PAGO DE LOS SERVICIOS DE OBRA, <strong>INMOBITEC</strong> PODRÁ EJECUTAR EL PAGARÉ, A FIN DE SATISFACER EL PAGO POR LA CONTRAPRESTACIÓN ECONÓMICA DE LOS SERVICIOS QUE HACE REFERENCIA EL PRESENTE CONTRATO.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>8.3</td>\r\n                    <td>EN CASO DE ATRASO EN EL PAGO DE LAS CUOTAS QUE ESTÁN CONTENIDAS EN EL <strong>ANEXO II</strong>, SE COBRARÁ UNA MORA EQUIVALENTE A S/1.00 (UNO CON 00/100 SOLES) POR DÍA CALENDARIO DE ATRASO.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"ninth-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA NOVENA: RESOLUCIÓN DE CONTRATO</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>9.1</td>\r\n                    <td>AMBAS PARTES ESTABLECEN QUE EL PRESENTE CONTRATO SE RESOLVERÁ AUTOMÁTICAMENTE DE ACUERDO CON LOS ARTÍCULOS 1428 Y 1430 DEL CÓDIGO CIVIL EN CASO EL <strong>BENEFICIARIO</strong> INCUMPLA EL PAGO DE TRES CUOTAS MENSUALES CONTINUAS O ALTERNAS DEL CRONOGRAMA ESTABLECIDO (<strong>ANEXO II</strong>).</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>9.2</td>\r\n                    <td> DEL MISMO MODO ACUERDAN QUE TAMBIÉN PODRÁ RESOLVERSE POR DESISTIMIENTO DE EL <strong>BENEFICIARIO</strong> DEBIDAMENTE COMUNICADO POR ESCRITO, EN ESTE ÚLTIMO CASO LA RESOLUCIÓN CONTRACTUAL SE CONFIGURARÁ A PARTIR DE LA APROBACIÓN DEL DESISTIMIENTO POR PARTE DE <strong>INMOBITEC</strong>.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>9.3</td>\r\n                    <td>AMBAS PARTES ACUERDAN QUE EN CASO DE RESOLVERSE EL PRESENTE CONTRATO POR CUALQUIERA DE LAS CAUSALES DESCRITAS EN EL NUMERAL 9.1 O 9.2 DEL PRESENTE CONTRATO, <strong>INMOBITEC</strong> DEVOLVERÁ A EL <strong>BENEFICIARIO</strong> EL MONTO DEL CINCUENTA POR CIENTO (50%), SÓLO SOBRE EL IMPORTE DE CUOTAS MENSUALES (DESCRITAS EN EL <strong>ANEXO II</strong>) DEBIDAMENTE PAGADAS HASTA EL MOMENTO DE LA RESOLUCIÓN DE CONTRATO, ELLO EN RAZÓN DE LA RETENCIÓN POR CONCEPTO DE INDEMNIZACIÓN QUE CORRESPONDE A <strong>INMOBITEC</strong>, UNA VEZ APROBADA LA LIQUIDACIÓN DE LA DEVOLUCIÓN DINERARIA, SE DEVOLVERÁ TAMBIÉN EL PAGARE QUE SUSCRIBIÓ EL <strong>BENEFICIARIO</strong>. LAS DEVOLUCIONES SERÁN PROGRAMADAS DE ACUERDO CON EL CRONOGRAMA MENSUAL APROBADO POR <strong>INMOBITEC</strong>.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>9.4</td>\r\n                    <td>DENTRO DEL MONTO DE APORTES AFECTABLE A DEVOLUCIÓN <strong>NO SE INCLUYE LA CUOTA INICIAL</strong> QUE QUEDARÁ INDEFECTIBLEMENTE Y EN SU TOTALIDAD PARA <strong>INMOBITEC</strong>, POR CONCEPTO DE INDEMNIZACIÓN; ASIMISMO TAMPOCO SE INCLUYE EN LA LIQUIDACIÓN DE DEVOLUCIÓN LAS MORAS QUE HUBIERA PAGADO EL <strong>BENEFICIARIO</strong>.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"tenth-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA DÉCIMA: RECEPCIÓN DE LA OBRA</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>10.1</td>\r\n                    <td>LAS PARTES DEJAN POR ESTABLECIDO QUE, LA RECEPCIÓN Y CONFORMIDAD DE LA OBRA MATERIA DEL PRESENTE CONTRATO SERÁ RECIBIDA POR <strong>LA ASOCIACIÓN DE VIVIENDA “CENTRO URBANO #sProyecto#”</strong>, LA QUE SUSCRIBIRÁ EN SU OPORTUNIDAD EL ACTA DE RECEPCIÓN DE OBRA, ES DECIR, QUE EL <strong>BENEFICIARIO</strong> CEDE SU DERECHO DE RECEPCIONAR LA OBRA A FAVOR DE <strong>LA ASOCIACIÓN DE VIVIENDA “CENTRO URBANO #sProyecto#”</strong>, DONDE EL <strong>BENEFICIARIO</strong> TIENE LA CONDICIÓN DE ASOCIADO.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"eleventh-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA DÉCIMA PRIMERA: DECLARACIÓN NO LAVADO DE ACTIVOS</strong><br>\r\n\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td> 11.1</td>\r\n                    <td>EL <strong>BENEFICIARIO</strong> DECLARA EXPRESAMENTE Y BAJO SU RESPONSABILIDAD QUE DE CONFORMIDAD CON EL DECRETO LEGISLATIVO N.º 1106 “LUCHA EFICAZ CONTRA EL LAVADO DE ACTIVOS Y OTROS DELITOS RELACIONADOS CON LA MINERÍA ILEGAL Y CRIMEN ORGANIZADO” QUE LOS FONDOS, BIENES, U ACTIVOS QUE ABONA A FAVOR DE <strong>INMOBITEC</strong> POR CONCEPTO DE CONTRAPRESTACIÓN ECONÓMICA EN RELACIÓN A LA OBRA MATERIA DEL PRESENTE CONTRATO, NO PROVIENEN, NI TIENEN RELACIÓN ALGUNA CON EL LAVADO DE ACTIVOS, ESPECIALMENTE EN LO QUE CONCIERNE A LA MINERÍA ILEGAL U OTRAS FORMAS DE CRIMEN ORGANIZADO, SIENDO SU ORIGEN LICITO, HACIENDO EXTENSIVA LA PRESENTE DECLARACIÓN A LOS MEDIOS DE PAGO UTILIZADOS, EN LA PRESENTE SUSCRIPCIÓN, EN CASO CORRESPONDA.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"twelfth-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA DÉCIMO SEGUNDA: HECHOS FORTUITOS Y FUERZA MAYOR</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>12.1</td>\r\n                    <td>EN CASO SE PRESENTEN HECHOS FORTUITOS O DE FUERZA MAYOR COMO DESASTRES NATURALES, PANDEMIAS, EVENTOS DE VIOLENCIA, TOMAS DE CARRETERAS, LLUVIAS PRODUCIDAS POR FENÓMENOS CLIMATOLOGICOS, EVENTOS POLÍTICOS, TERRORISMO Y OTROS <strong>INMOBITEC</strong> NO SE HACE RESPONSABLE POR LA PARALIZACIÓN EN EL AVANCE DE LA OBRA.\r\n                    </td>\r\n                </tr>\r\n                <tr>\r\n                    <td>12.2</td>\r\n                    <td>EN CASO SUCEDAN LOS HECHOS DESCRITOS EN EL NUMERAL ANTERIOR, EL CRONOGRAMA DE OBRA SERÁ MODIFICADO SIN EL CONSENTIMIENTO DE EL <strong>BENEFICIARIO</strong>, A QUIEN SE LE COMUNICARÁ MEDIANTE CARTA A SU DOMICILIO Y/O CORREO ELECTRONICO Y/O NÚMERO TELÉFONO DE WHATSSAP, DÁNDOLE A CONOCER LOS MOTIVOS DEL ATRASO DE LAS OBRAS SIN GENERAR NINGÚN TIPO DE RESPONSABILIDAD O PENALIDAD A <strong>INMOBITEC</strong>.\r\n                    </td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"thirteen-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA DÉCIMOTERCERA: DATOS PERSONALES DEL BENEFICIARIO.</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>13.1</td>\r\n                    <td>LOS DATOS PERSONALES QUE EL <strong>BENEFICIARIO</strong> FACILITE A <strong>INMOBITEC</strong> SERÁN UTILIZADOS CON LA FINALIDAD DE EJECUTAR LA RELACIÓN QUE LOS VINCULA EN VIRTUD DEL PRESENTE CONTRATO, POR LO QUE EL <strong>BENEFICIARIO</strong> RECONOCE HABER SIDO INFORMADO DE LA INCORPORACIÓN DE ESTOS AL BANCO DE DATOS PERSONALES DENOMINADO \"PROGRAMA SOCIAL DE VIVIENDA #sProyecto#</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>13.2</td>\r\n                    <td> EL <strong>BENEFICIARIO</strong> PUEDE EJERCER SUS DERECHOS (RECTIFICACIÓN, OPOSICIÓN, CANCELACIÓN, ETC.), EN LOS TÉRMINOS PREVISTOS EN LA LEY N.º 29733 - LEY DE PROTECCIÓN DE DATOS PERSONALES Y SU REGLAMENTO, PRESENTANDO UNA SOLICITUD ESCRITA A EL VENDEDOR EN SU DOMICILIO SEÑALADO EN EL PRESENTE CONTRATO.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"fourteenth-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA DÉCIMA CUARTA: LAS COMUNICACIONES Y NOTIFICACIONES.</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>14.1</td>\r\n                    <td>AMBAS PARTES SEÑALAN COMO SUS RESPECTIVOS DOMICILIOS LOS INDICADOS EN LA INTRODUCCIÓN DEL PRESENTE DOCUMENTO, A EFECTOS DE VALIDAR LAS COMUNICACIONES Y NOTIFICACIONES A LAS PARTES CON MOTIVO DE EJECUCIÓN DEL PRESENTE CONTRATO ACUERDAN QUE EL CAMBIO DE DOMICILIO DE CUALQUIERA DE LAS PARTES DEBERÁ COMUNICARSE POR ESCRITO PARA QUE TENGA VALIDEZ, SURTIENDO EFECTOS DESDE EL DÍA HÁBIL SIGUIENTE DE LA FECHA DE LA COMUNICACIÓN DE DICHO CAMBIO A LA OTRA PARTE.</td>\r\n                </tr>\r\n                <tr>\r\n                    <td>14.2</td>\r\n                    <td>ASÍ MISMO, EL <strong>BENEFICIARIO</strong> AUTORIZA A SER NOTIFICADO MEDIANTE CARTA A SU DOMICILIO Y/O CORREO ELECTRONICO Y/O NÚMERO TELÉFONO DE WHATSSAP DE ACUERDO CON LOS DATOS PROPORCIONADOS EN LAS GENERALES DE LEY. QUE PERMITA UNA COMUNICACIÓN EFECTIVA ENTRE LAS PARTES. ASÍ MISMO, ESTE ACTO ES DECLARATIVO POR PARTE DEL <strong>BENEFICIARIO</strong> LO QUE IMPLICA UNA MANIFESTACIÓN DE SU VOLUNTAD RESPECTO DEL MEDIO DE NOTIFICACIÓN.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"fifteenth-clause\">\r\n            <p>\r\n                <strong>CLÁUSULA DÉCIMA QUINTA: SOLUCIÓN DE CONTROVERSIAS</strong><br>\r\n            </p>\r\n            <table class=\"clause-content\">\r\n                <tr>\r\n                    <td>15.1</td>\r\n                    <td>LAS PARTES ACUERDAN QUE LOS MECANISMOS PARA LA SOLUCIÓN DE CONTROIVERSIAS SON EL DIÁLOGO DIRECTO, LA CONCILIACIÓN EXTRAJUDICIAL, EN CASO LAS PARTES NO SE PONGAN DE ACUERDO AMBAS SE SOMETEN A LA JURISDICCIÓN DE LOS JUECES LA CIUDAD DE LIMA.</td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        <div class=\"text-right\" style=\"padding-top:15px; padding-bottom:0px; text-align: right\">#sFechaFirma#</div>\r\n        <table style=\"width:100%; border-collapse: collapse;\">\r\n            <tr>\r\n                <td class=\"text-center\" style=\"width: 330px\">\r\n                    <div style=\"width: 100%; height: 60px;\">\r\n                        <img id=\"firma02\" src=\"img/firma_luis_gutierrez_2023.png\" width=\"250px\" alt=\"firma\">\r\n                    </div>\r\n                </td>\r\n                <td class=\"text-center\" style=\"width: 300px\">\r\n                    <div style=\"width: 100%; height: 60px;\"></div>\r\n                    <div><b><strong>EL BENEFICIARIO</strong></b></div>\r\n                </td>\r\n            </tr>\r\n            #IniDatosConyugue#\r\n            <tr>\r\n                <td style=\"width:200px\"></td>\r\n                <td class=\"text-center\" style=\"width: 300px\">\r\n                    <div style=\"width: 100%; height: 40px;\"></div>\r\n                    <div style=\"text-transform: uppercase;\"><b>#sNobreConyugue#</b></div>\r\n                    <div>#sTipoDocumentoConyugue# N.° #sDocumentoConyugue#</div>\r\n                    <div><b>BENEFICIARIO</b></div>\r\n                </td>\r\n            </tr>\r\n            #FinDatosConyugue#\r\n        </table>\r\n    </div>\r\n    <div class=\"page-break\"></div>\r\n</body>\r\n</html>";

                var html = "";

                html += sCuerpo
                        .Replace("img/firma_luis_gutierrez_2023.png", dataImages.firmaLuisGutierrez);

                string path = System.IO.Path.Combine(System.IO.Path.GetTempPath(), Guid.NewGuid() + ".pdf");
                ConverterProperties properties = new ConverterProperties();
                properties.SetFontProvider(new DefaultFontProvider(true, true, true));
                PdfDocument pdfDocument = new PdfDocument(new PdfWriter(path));
                pdfDocument.SetDefaultPageSize(new PageSize(PageSize.A4));

                Byte[] imageBytes = Convert.FromBase64String(dataImages.cesionGardenias.Replace("data:image/png;base64,", ""));
                Image image = new Image(ImageDataFactory.Create(imageBytes));
                image.SetWidth(pdfDocument.GetDefaultPageSize().GetWidth());
                image.SetHeight(pdfDocument.GetDefaultPageSize().GetHeight());
                image.SetFixedPosition(0, 0);
                image.SetOpacity(1f);
                pdfDocument.AddEventHandler(PdfDocumentEvent.END_PAGE, new BackgroundImageHandler(image));

                HtmlConverter.ConvertToPdf(html, pdfDocument, properties);

                string path2 = System.IO.Path.Combine(System.IO.Path.GetTempPath(), Guid.NewGuid() + ".pdf");
                PdfDocument pdfDoc = new PdfDocument(new PdfReader(path), new PdfWriter(path2));
                Document doc = new Document(pdfDoc);

                int numberOfPages = pdfDoc.GetNumberOfPages();
                for (int i = 1; i <= numberOfPages; i++)
                {
                    doc.ShowTextAligned(new Paragraph(i + "/" + numberOfPages).SetFontSize(10), (pdfDocument.GetDefaultPageSize().GetWidth() / 2), 20, i, TextAlignment.RIGHT, VerticalAlignment.BOTTOM, 0);
                }

                doc.Close();

                byte[] file = System.IO.File.ReadAllBytes(path2);
                return File(file, "application/pdf");
            }
            catch (Exception)
            {

                throw;
            }
        }
    }

    public class BackgroundImageHandler : IEventHandler 
    {
        protected Image img;
        public BackgroundImageHandler(Image _img)
        {
            this.img = _img;
        }

        public void HandleEvent(Event @event) {
            PdfDocumentEvent docEvent = (PdfDocumentEvent) @event;
            PdfDocument pdfDoc = docEvent.GetDocument();
            PdfPage page = docEvent.GetPage();
            PdfCanvas canvas = new PdfCanvas(page.NewContentStreamBefore(), page.GetResources(), pdfDoc);
            Rectangle area = page.GetPageSize();
            new Canvas(canvas, area).Add(img);
        }
    }
}
